<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>æˆ‘çš„è®°è´¦æœ¬</title>
<style>
  :root{
    --bg:#0b0e11; --panel:#12161c; --panel-2:#171c22; --text:#e7edf3; --muted:#9fb3c8;
    --primary:#4c8bf5; --positive:#16a34a; --negative:#ef4444; --warn:#f59e0b;
    --border:#243140; --shadow:0 6px 18px rgba(0,0,0,.25);
    --tooltip-bg:rgba(20,24,33,.95); --tooltip-text:#e7edf3; --tooltip-border:#2b394a;
  }
  body.light{
    --bg:#f5f7fb; --panel:#ffffff; --panel-2:#f2f5fb; --text:#0e1520; --muted:#5a6b7d;
    --primary:#3b82f6; --positive:#16a34a; --negative:#ef4444; --warn:#d97706;
    --border:#d8e0ea; --shadow:0 6px 18px rgba(0,0,0,.08);
    --tooltip-bg:rgba(255,255,255,.98); --tooltip-text:#0e1520; --tooltip-border:#c7d2e0;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans",sans-serif;background:var(--bg);color:var(--text)}
  a{color:var(--primary);text-decoration:none}
  .container{max-width:1140px;margin:0 auto;padding:16px}
  header.top{position:sticky;top:0;z-index:5;background:linear-gradient(180deg, rgba(11,14,17,0.95), rgba(11,14,17,0.75));backdrop-filter: blur(6px);}
  body.light header.top{background:linear-gradient(180deg, rgba(245,247,251,.95), rgba(245,247,251,.75));}
  .brand{display:flex;align-items:center;gap:10px;padding:12px 8px;flex-wrap:wrap}
  .brand .logo{width:24px;height:24px;border-radius:6px;background:linear-gradient(135deg,var(--primary),#7aa8ff)}
  .brand h1{font-size:16px;margin:0}
  nav.tabs{display:flex;gap:8px;flex-wrap:wrap;padding:0 8px 12px}
  nav.tabs button{appearance:none;border:1px solid var(--border);background:var(--panel-2);color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
  nav.tabs button.active{background:var(--primary);border-color:transparent}

  .grid{display:grid;gap:14px}
  .g-2{grid-template-columns:repeat(2,1fr)}
  .g-3{grid-template-columns:repeat(3,1fr)}
  @media(max-width:980px){.g-3{grid-template-columns:repeat(2,1fr)}.g-2{grid-template-columns:1fr}}
  @media(max-width:640px){.g-3{grid-template-columns:1fr}}

  .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow)}
  .card h3{margin:0 0 8px 0;font-size:16px}
  .section{display:none}
  .section.active{display:block}
  .card .content{padding:14px}
  .muted{color:var(--muted)}
  .row{display:flex;gap:10px;align-items:center}
  .space{flex:1}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;background:var(--panel-2);border:1px solid var(--border);font-size:12px;color:var(--muted)}
  .btn{appearance:none;border:1px solid var(--border);background:var(--panel-2);color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
  .btn.primary{background:var(--primary);border-color:transparent}
  .btn.warn{background:var(--warn);border-color:transparent}
  .btn.ghost{background:transparent}
  .btn.positive{background:var(--positive);border-color:transparent}
  .btn.negative{background:var(--negative);border-color:transparent}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap}

  .field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
  .field label{font-size:12px;color:var(--muted)}
  .field input,.field select,.field textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--panel-2);color:var(--text)}
  .field input[type="date"]{padding:8px 10px}

  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
  th{color:var(--muted);font-weight:600}
  tr:hover td{background:rgba(0,0,0,.04)}
  body.light tr:hover td{background:rgba(0,0,0,.03)}
  .amount{font-variant-numeric:tabular-nums}
  .amount.positive{color:var(--positive)}
  .amount.negative{color:var(--negative)}

  .kpi{display:flex;flex-direction:column;gap:4px}
  .kpi .label{color:var(--muted);font-size:12px}
  .kpi .value{font-size:20px;font-weight:700}
  .progress{height:10px;background:var(--panel-2);border:1px solid var(--border);border-radius:999px;overflow:hidden}
  .progress>i{display:block;height:100%;background:linear-gradient(90deg,var(--primary),#7aa8ff);width:0%}
  .tag{padding:2px 6px;border:1px solid var(--border);border-radius:999px;font-size:12px;color:var(--muted)}

  footer{padding:24px 0;color:var(--muted);text-align:center}
  .note{font-size:12px;color:var(--muted)}

  .danger{border:1px dashed #6b1f1f;background:#1a0f10}
  body.light .danger{border-color:#f1c0c0;background:#fff2f2}
  canvas{width:100%;height:260px;display:block}

  .drag-handle{cursor:grab; user-select:none; font-size:18px; opacity:.8}
  tr.dragging{opacity:.6}
  tr.drop-target{outline:2px dashed var(--primary)}
  .legend{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .legend .item{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--muted)}
  .legend .swatch{width:10px;height:10px;border-radius:2px}

  .tooltip{position:fixed;z-index:20;display:none;pointer-events:none;min-width:140px;
    background:var(--tooltip-bg); color:var(--tooltip-text); border:1px solid var(--tooltip-border);
    padding:8px 10px; border-radius:10px; box-shadow:var(--shadow); font-size:12px}
  .tooltip .title{font-weight:700;margin-bottom:4px}
  .tooltip .row{display:flex;justify-content:space-between;gap:12px}

  /* ç¼–è¾‘çŠ¶æ€æ ‡è®° */
  .editing-badge{display:none;margin-left:8px}
  .editing .editing-badge{display:inline-flex}
</style>
<style>
  .badge-origin{ margin-left:8px; }
</style>
</head>
<body>
<header class="top">
  <div class="container brand">
    <div class="logo" aria-hidden="true"></div>
     <h1>æˆ‘çš„è®°è´¦æœ¬ Â· å•æ–‡ä»¶åŸå‹</h1> <span class="pill badge-origin">åŸåˆ›ï¼šåŒæ’ç½‘ç»œ gree020.cn</span>
    <span class="pill" id="profilePill">ğŸ” ID: <b id="profileIdShow"></b></span>
    <button class="btn" id="switchIdBtn" title="åˆ‡æ¢/æ–°å»º ID">åˆ‡æ¢ID</button>
    <div class="space"></div>
    <button class="btn" id="toggleThemeBtn" title="åˆ‡æ¢æµ…è‰²/æ·±è‰²">ğŸŒ“ ä¸»é¢˜</button>
    <button class="btn" id="toggleMaskBtn" title="é‡‘é¢é®ç½©">ğŸ™ˆ é‡‘é¢é®ç½©</button>
  </div>
  <div class="container">
    <nav class="tabs" id="tabs"></nav>
  </div>
</header>

<main class="container">
  <!-- ä»ªè¡¨ç›˜ -->
  <section id="sec-dashboard" class="section active">
    <div class="grid g-3">
      <div class="card"><div class="content kpi">
        <span class="label">å‡€èµ„äº§ï¼ˆæŠ˜ç®—è‡³åŸºå‡†ï¼‰</span>
        <span id="netWorth" class="value amount">--</span>
        <span id="netWorthNote" class="note"></span>
      </div></div>
      <div class="card"><div class="content kpi">
        <span class="label">æœ¬æœˆæ”¶å…¥ï¼ˆåŸºå‡†ï¼‰</span>
        <span id="monthIn" class="value amount negative">--</span>
      </div></div>
      <div class="card"><div class="content kpi">
        <span class="label">æœ¬æœˆæ”¯å‡ºï¼ˆåŸºå‡†ï¼‰</span>
        <span id="monthOut" class="value amount positive">--</span>
      </div></div>
    </div>

    <div class="grid g-2" style="margin-top:14px">
      <div class="card"><div class="content">
        <div class="row"><h3>è´¦æˆ·æ¦‚è§ˆ</h3><div class="space"></div><span class="note">æ”¯æŒå¤šå¸ç§ï¼ŒæŒ‰åŸºå‡†æŠ˜ç®—</span></div>
        <div id="accountCards" class="grid g-3"></div>
        <div class="toolbar" style="margin-top:12px">
          <button class="btn primary" data-nav="#sec-accounts">â• æ–°å»ºè´¦æˆ·</button>
          <button class="btn" data-nav="#sec-trans">âœï¸ è®°ä¸€ç¬”</button>
        </div>
      </div></div>

      <div class="card"><div class="content">
        <div class="row"><h3>èµ„äº§ç»“æ„ï¼ˆæŒ‰è´¦æˆ·ï¼‰</h3><div class="space"></div><span class="note" id="acctDonutNote"></span></div>
        <canvas id="acctDonut" height="260"></canvas>
        <div class="legend" id="acctLegend"></div>
      </div></div>
    </div>

    <div class="card" style="margin-top:14px"><div class="content">
      <div class="row"><h3>æœ€è¿‘äº¤æ˜“</h3><div class="space"></div><span class="note">ç‚¹å‡»"ç¼–è¾‘"å¯ç›´æ¥ä¿®æ”¹</span></div>
      <table id="recentTxTable">
        <thead><tr><th>æ—¥æœŸ</th><th>è´¦æˆ·</th><th>åˆ†ç±»/å¤‡æ³¨</th><th style="text-align:right">é‡‘é¢</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
    </div></div>
  </section>

  <!-- è´¦æˆ· -->
  <section id="sec-accounts" class="section">
    <div class="card"><div class="content">
      <div class="row">
        <h3>è´¦æˆ·åˆ—è¡¨</h3>
        <div class="space"></div>
        <span class="note">æŒ‰ä½å·¦ä¾§"â‹®â‹®"æ‹–åŠ¨è¡Œæ’åºï¼ˆä»…å½“å‰ ID ç”Ÿæ•ˆï¼‰</span>
        <button class="btn primary" id="btnAddAccount" style="margin-left:8px">æ–°å¢è´¦æˆ·</button>
      </div>
      <table id="accountsTable">
        <thead><tr><th style="width:32px"></th><th>åç§°</th><th>ç±»å‹</th><th>å¸ç§</th><th>è®¡å…¥å‡€èµ„äº§</th><th style="text-align:right">ä½™é¢ï¼ˆæœ¬å¸ï¼‰</th><th style="text-align:right">â‰ˆ åŸºå‡†</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
    </div></div>

    <div class="card"><div class="content">
      <h3>æ–°å»º/ç¼–è¾‘è´¦æˆ·</h3>
      <form id="accountForm" class="grid g-3">
        <div class="field"><label>åç§°</label><input required id="acc_name" /></div>
        <div class="field"><label>ç±»å‹</label>
          <select id="acc_type">
            <option value="cash">ç°é‡‘</option>
            <option value="bank">é“¶è¡Œå¡</option>
            <option value="credit">ä¿¡ç”¨å¡</option>
            <option value="investment">ç†è´¢/æŠ•èµ„</option>
            <option value="loan">è´Ÿå€º/è´·æ¬¾</option>
            <option value="wallet">é’±åŒ…/å¹³å°</option>
            <option value="other">å…¶ä»–</option>
          </select>
        </div>
        <div class="field"><label>å¸ç§</label>
          <select id="acc_currency">
            <option value="CNY">CNY</option>
            <option value="HKD">HKD</option>
            <option value="USD">USD</option>
            <option value="EUR">EUR</option>
          </select>
        </div>
        <div class="field"><label>æœŸåˆä½™é¢</label><input id="acc_opening" type="number" step="0.01" value="0" /></div>
        <div class="field"><label>è®¡å…¥å‡€èµ„äº§</label>
          <select id="acc_in_net">
            <option value="true">æ˜¯</option>
            <option value="false">å¦</option>
          </select>
        </div>
        <div class="field"><label>æ’åº</label><input id="acc_sort" type="number" value="0" /></div>
        <div class="row" style="grid-column:1/-1;gap:8px">
          <input type="hidden" id="acc_id" />
          <button class="btn primary" type="submit">ä¿å­˜è´¦æˆ·</button>
          <button class="btn" type="button" id="btnResetAccountForm">æ¸…ç©ºè¡¨å•</button>
        </div>
      </form>
    </div></div>
  </section>

  <!-- äº¤æ˜“ -->
  <section id="sec-trans" class="section">
    <div class="card"><div class="content">
      <div class="row">
        <h3>è®°ä¸€ç¬”</h3>
        <span class="pill editing-badge" id="txEditingPill">âœï¸ æ­£åœ¨ç¼–è¾‘æµæ°´</span>
        <div class="space"></div>
        <span class="pill">å¿«æ·é”®ï¼šN</span>
      </div>
      <form id="txnForm" class="grid g-3">
        <div class="field"><label>æ—¥æœŸ</label><input id="tx_date" type="date" required /></div>
        <div class="field"><label>ç±»å‹</label>
          <select id="tx_type">
            <option value="out">æ”¯å‡º</option>
            <option value="in">æ”¶å…¥</option>
            <option value="transfer">è½¬è´¦</option>
          </select>
        </div>
        <div class="field"><label>æ¥æº/ä¸»è´¦æˆ·</label><select id="tx_account"></select></div>
        <div class="field transfer-only" style="display:none"><label>ç›®æ ‡è´¦æˆ·ï¼ˆè½¬è´¦ï¼‰</label><select id="tx_target"></select></div>
        <div class="field"><label>é‡‘é¢</label><input id="tx_amount" type="number" step="0.01" required /></div>
        <div class="field non-transfer"><label>åˆ†ç±»</label>
          <select id="tx_category"></select>
        </div>
        <div class="field"><label>å¯¹æ–¹</label><input id="tx_payee" placeholder="å•†å®¶/å•ä½/æœ‹å‹â€¦" /></div>
        <div class="field" style="grid-column:1/-1"><label>å¤‡æ³¨</label><input id="tx_memo" /></div>
        <input type="hidden" id="tx_edit_id" />
        <input type="hidden" id="tx_edit_peer_id" />
        <input type="hidden" id="tx_edit_transfer" />
        <div class="row" style="grid-column:1/-1;gap:8px">
          <button class="btn primary" type="submit">ä¿å­˜</button>
          <button class="btn" type="reset" id="btnResetTx">é‡ç½®</button>
          <button class="btn warn" type="button" id="btnCancelEditTx" style="display:none">å–æ¶ˆç¼–è¾‘</button>
        </div>
      </form>
    </div></div>

    <div class="card"><div class="content">
      <div class="row"><h3>æµæ°´</h3>
        <div class="space"></div>
        <div class="row">
          <label class="muted">ç­›é€‰ï¼š</label>
          <select id="filter_account"></select>
          <input id="filter_kw" placeholder="å…³é”®å­—/åˆ†ç±»/å¯¹æ–¹" />
          <button class="btn" id="btnClearFilter">æ¸…ç©º</button>
        </div>
      </div>
      <table id="txTable">
        <thead><tr><th>æ—¥æœŸ</th><th>è´¦æˆ·</th><th>ç±»å‹</th><th>åˆ†ç±»/å¯¹æ–¹</th><th>å¤‡æ³¨</th><th style="text-align:right">é‡‘é¢</th><th style="text-align:right">æ“ä½œ</th></tr></thead>
        <tbody></tbody>
      </table>
    </div></div>
  </section>

  <!-- é¢„ç®— -->
  <section id="sec-budget" class="section">
    <div class="card"><div class="content">
      <div class="row"><h3>æœ¬æœˆé¢„ç®—</h3><div class="space"></div><span class="muted" id="budgetMonthLabel"></span></div>
      <div class="grid g-3" id="budgetGrid"></div>
    </div></div>

    <div class="card"><div class="content">
      <div class="row">
        <h3>è®¾ç½®é¢„ç®—</h3>
        <span class="pill editing-badge" id="bdgEditingPill">âœï¸ æ­£åœ¨ç¼–è¾‘é¢„ç®—</span>
      </div>
      <form id="budgetForm" class="grid g-3">
        <div class="field"><label>åˆ†ç±»</label><select id="bdg_category"></select></div>
        <div class="field"><label>æœˆé¢„ç®—é‡‘é¢ï¼ˆåŸºå‡†ï¼‰</label><input id="bdg_amount" type="number" step="0.01" /></div>
      <input type="hidden" id="bdg_edit_key"/>
        <div class="row" style="grid-column:1/-1;gap:8px">
          <button class="btn primary" type="submit">ä¿å­˜é¢„ç®—</button>
          <button class="btn" type="reset" id="btnResetBudget">æ¸…ç©º</button>
          <button class="btn warn" type="button" id="btnCancelEditBudget" style="display:none">å–æ¶ˆç¼–è¾‘</button>
        </div>
      </form>
      <p class="note">åœ¨"æœ¬æœˆé¢„ç®—"å¡ç‰‡ä¸Šç‚¹å‡»"ç¼–è¾‘/åˆ é™¤"å³å¯ç®¡ç†å·²è®¾ç½®çš„é¢„ç®—ã€‚</p>
    </div></div>
  </section>

  <!-- æŠ¥è¡¨ -->
  <section id="sec-reports" class="section">
    <div class="card"><div class="content">
      <div class="row"><h3>12 ä¸ªæœˆæ”¶æ”¯è¶‹åŠ¿ï¼ˆåŸºå‡†ï¼‰</h3><div class="space"></div><span class="note" id="trendNote"></span></div>
      <canvas id="lineChart" height="260"></canvas>
    </div></div>

    <div class="card"><div class="content">
      <div class="row"><h3>æœ¬æœˆæ”¯å‡ºåˆ†ç±»å æ¯”ï¼ˆåŸºå‡†ï¼‰</h3><div class="space"></div><span class="note" id="pieNote"></span></div>
      <canvas id="pieChart" height="260"></canvas>
    </div></div>
  </section>

  <!-- è®¾ç½® / æ•°æ® -->
  <section id="sec-settings" class="section">
    <div class="card"><div class="content">
      <h3>åå¥½è®¾ç½®ï¼ˆä»…å½“å‰ ID ç”Ÿæ•ˆï¼‰</h3>
      <form id="prefsForm" class="grid g-3">
        <div class="field"><label>åŸºå‡†è´§å¸</label>
          <select id="baseCurrency">
            <option value="CNY">CNY (Â¥)</option>
            <option value="HKD">HKD (HK$)</option>
            <option value="USD">USD ($)</option>
            <option value="EUR">EUR (â‚¬)</option>
          </select>
          <span class="note">æ›´æ”¹åè¯·åˆ°ä¸‹æ–¹"æ±‡ç‡ç®¡ç†"æ›´æ–°å„å¸ç§å…‘åŸºå‡†çš„æ±‡ç‡ã€‚</span>
        </div>
        <div class="field"><label>é‡‘é¢é®ç½©</label>
          <select id="maskAmounts">
            <option value="false">å…³é—­</option>
            <option value="true">å¼€å¯</option>
          </select>
        </div>
        <div class="field"><label>ä¸»é¢˜</label>
          <select id="themeSelect">
            <option value="dark">æ·±è‰²</option>
            <option value="light">æµ…è‰²</option>
          </select>
        </div>
        <div class="row" style="grid-column:1/-1;gap:8px">
          <button class="btn primary" type="submit">ä¿å­˜è®¾ç½®</button>
        </div>
      </form>
      <p class="note">æç¤ºï¼šID åˆ‡æ¢æŒ‰é’®åœ¨é¡¶éƒ¨ï¼›æ¯ä¸ª ID çš„æ•°æ®ä¸è®¾ç½®äº’ä¸å½±å“ã€‚</p>
    </div></div>

    <div class="card"><div class="content">
      <div class="row"><h3>æ±‡ç‡ç®¡ç†ï¼ˆ1 å¤–å¸ = ? åŸºå‡†ï¼‰</h3><div class="space"></div><span class="note">æ•°æ®æºï¼šopen.er-api.comï¼ˆå·²è‡ªåŠ¨æ–¹å‘è½¬æ¢ï¼‰</span></div>
      <table id="fxTable">
        <thead><tr><th>å¤–å¸</th><th style="text-align:right">æ±‡ç‡</th><th>æ›´æ–°æ—¶é—´</th><th style="text-align:right"></th></tr></thead>
        <tbody></tbody>
      </table>
      <form id="fxForm" class="grid g-3" style="margin-top:10px">
        <div class="field"><label>å¤–å¸ï¼ˆ3 å­—æ¯ï¼‰</label><input id="fx_quote" placeholder="å¦‚ USD/HKD/EUR" maxlength="6" /></div>
        <div class="field"><label>æ±‡ç‡ï¼ˆå¤–å¸â†’åŸºå‡†ï¼‰</label><input id="fx_rate" type="number" step="0.0001" placeholder="ä¾‹å¦‚ USDâ†’CNY å†™ 7.12" /></div>
        <div class="row" style="grid-column:1/-1;gap:8px">
          <button class="btn primary" type="submit">ä¿å­˜/æ›´æ–°</button>
          <button class="btn" type="button" id="fxReset">æ¸…ç©º</button>
        </div>
      </form>
      <div class="toolbar" style="margin-top:8px">
        <button class="btn" id="fxFetchAccounts">æ ¹æ®è´¦æˆ·å¸ç§è”ç½‘æ›´æ–°</button>
        <button class="btn" id="fxFetchAll">å…¨é‡æ›´æ–°ï¼ˆå¸¸è§å¸ç§ï¼‰</button>
      </div>
    </div></div>
<div class="card"><div class="content">
      <div class="row">
        <h3>æ•°æ®å¯¼å…¥ / å¯¼å‡º</h3>
        <div class="space"></div>
        <span class="note">ä»…ä½œç”¨äºå½“å‰ IDï¼š<b id="dataProfileId"></b></span>
      </div>
      <div class="toolbar" style="margin-top:8px">
        <button class="btn" id="btnExportData">å¯¼å‡º JSON</button>
        <input type="file" id="importFile" accept="application/json" style="display:none" />
        <button class="btn" id="btnImportData">å¯¼å…¥ JSON</button>
        <button class="btn negative" id="btnClearCurrentData">æ¸…ç©ºå½“å‰ ID æ•°æ®</button>
      </div>
      <p class="note">å¯¼å…¥ä¸º"åˆå¹¶å¯¼å…¥"ï¼ŒåŒ ID è®°å½•å°†è¢«è¦†ç›–ã€‚æ“ä½œå‰å»ºè®®å…ˆå¯¼å‡ºå¤‡ä»½ã€‚</p>
    </div></div>


    <div class="card danger"><div class="content">
      <strong>âš ï¸ æç¤º</strong>
      <p class="note">æœ¬ç‰ˆæœ¬æ–°å¢ï¼šäº¤æ˜“æµæ°´å¯ç¼–è¾‘ï¼›é¢„ç®—å¯ç¼–è¾‘/åˆ é™¤ã€‚é¡¶éƒ¨ç‚¹å‡»"åˆ‡æ¢ID"ç®¡ç†å¤šè´¦æˆ·ç©ºé—´ã€‚</p>
    </div></div>
  </section>
</main>

<footer class="container">Made with "åŒæ’ç½‘ç»œ gree020.cn"</footer>

<div id="tooltip" class="tooltip"></div>

<script>
// ====== å·¥å…· & Profile ======
const $ = (sel,root=document)=>root.querySelector(sel);
const $$ = (sel,root=document)=>Array.from(root.querySelectorAll(sel));
const uid = ()=>crypto.randomUUID();
const todayStr = ()=>new Date().toISOString().slice(0,10);
const ym = (d)=>{const x=new Date(d);return x.getFullYear()+"-"+(String(x.getMonth()+1).padStart(2,'0'))}
const sameMonth = (a,b)=>ym(a)===ym(b);
const getCurrentProfile = ()=> localStorage.getItem('ledger_profile') || 'default';
const setCurrentProfile = (id)=>{ localStorage.setItem('ledger_profile', id || 'default'); };

let mask = false;
const CURRENCY_SYMBOLS={CNY:'Â¥',HKD:'HK$',USD:'$',EUR:'â‚¬'};
const currencySymbol = c=>CURRENCY_SYMBOLS[c]||c+" ";
function fmtAmount(v,cur){
  if(v===undefined||v===null||Number.isNaN(v)) return '--';
  const s = (Number(v).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}));
  return (mask? '****' : (currencySymbol(cur||state.prefs.baseCurrency)+s));
}

// ====== IndexedDBï¼ˆv5 å¤š IDï¼‰ ======
const DB_NAME='ledger_v1';
let db=null;
function openDB(){
  return new Promise((resolve,reject)=>{
    const req=indexedDB.open(DB_NAME,5);
    req.onupgradeneeded=e=>{
      const d=e.target.result; let s;
      if(!d.objectStoreNames.contains('accounts')){
        s=d.createObjectStore('accounts',{keyPath:'id'});
      } else { s=e.target.transaction.objectStore('accounts'); }
      try{s.createIndex('by_profile','profileId',{unique:false});}catch{}
      try{s.createIndex('by_sort','sort',{unique:false});}catch{}
      if(!d.objectStoreNames.contains('transactions')){
        s=d.createObjectStore('transactions',{keyPath:'id'});
      } else { s=e.target.transaction.objectStore('transactions'); }
      try{s.createIndex('by_date','date',{unique:false});}catch{}
      try{s.createIndex('by_account','accountId',{unique:false});}catch{}
      try{s.createIndex('by_profile','profileId',{unique:false});}catch{}
      if(d.objectStoreNames.contains('budgets')) d.deleteObjectStore('budgets');
      s=d.createObjectStore('budgets',{keyPath:'key'});
      try{s.createIndex('by_profile','profileId',{unique:false});}catch{}
      if(!d.objectStoreNames.contains('prefs')){
        d.createObjectStore('prefs',{keyPath:'key'});
      }
      if(d.objectStoreNames.contains('fxrates')) d.deleteObjectStore('fxrates');
      s=d.createObjectStore('fxrates',{keyPath:'key'});
      try{s.createIndex('by_profile','profileId',{unique:false});}catch{}
    };
    req.onsuccess=e=>{db=e.target.result;resolve(db)};
    req.onerror=e=>reject(e.target.error);
  });
}
function tx(storeNames,mode='readonly'){
  const t=db.transaction(storeNames,mode); return storeNames.map(n=>t.objectStore(n));
}
const idb={
  async getAll(store){return new Promise((res,rej)=>{const [s]=tx([store]);const r=s.getAll();r.onsuccess=()=>res(r.result);r.onerror=()=>rej(r.error);});},
  async put(store,val){return new Promise((res,rej)=>{const [s]=tx([store],'readwrite');const r=s.put(val);r.onsuccess=()=>res(true);r.onerror=()=>rej(r.error);});},
  async del(store,key){return new Promise((res,rej)=>{const [s]=tx([store],'readwrite');const r=s.delete(key);r.onsuccess=()=>res(true);r.onerror=()=>rej(r.error);});},
  async clear(store){return new Promise((res,rej)=>{const [s]=tx([store],'readwrite');const r=s.clear();r.onsuccess=()=>res(true);r.onerror=()=>rej(r.error);});},
  async setPrefRaw(key,value){return idb.put('prefs',{key,value});},
  async getPrefRaw(key){return new Promise((res,rej)=>{const [s]=tx(['prefs']);const r=s.get(key);r.onsuccess=()=>res(r.result? r.result.value:undefined);r.onerror=()=>rej(r.error);});}
};
const pkey = (k)=> `${state.profileId}::${k}`;

// ====== å…¨å±€çŠ¶æ€ ======
const state={profileId:getCurrentProfile(), accounts:[], txs:[], budgets:{}, fxrates:{}, prefs:{baseCurrency:'CNY', maskAmounts:false, theme:'dark'}};

// ====== ä¸»é¢˜ / åå¥½ ======
function applyTheme(theme){
  document.body.classList.toggle('light', theme==='light');
  state.prefs.theme=theme;
}
async function savePrefs(){
  await idb.setPrefRaw(pkey('baseCurrency'),state.prefs.baseCurrency);
  await idb.setPrefRaw(pkey('maskAmounts'),state.prefs.maskAmounts);
  await idb.setPrefRaw(pkey('theme'),state.prefs.theme);
}

// ====== æ±‡ç‡å·¥å…· ======
function rateToBase(currency){
  if(!currency || currency===state.prefs.baseCurrency) return 1;
  const q=(state.fxrates[currency]!==undefined)? Number(state.fxrates[currency]) : null;
  return q && q>0 ? q : null;
}
function amountToBase(amount,currency){
  if(currency===state.prefs.baseCurrency) return Number(amount)||0;
  const r=rateToBase(currency); return r? (Number(amount)||0)*r : null;
}
async function fetchRatesOpenERAPI(base, quotes){
  const url=`https://open.er-api.com/v6/latest/${encodeURIComponent(base)}`;
  const resp=await fetch(url,{mode:'cors'});
  if(!resp.ok) throw new Error('HTTP '+resp.status);
  const data=await resp.json();
  if(!data || !data.rates) throw new Error('å“åº”æ ¼å¼å¼‚å¸¸');
  const out={};
  quotes.forEach(q=>{
    const v = data.rates[q];
    if(v!=null && v>0){
      out[q] = 1 / v; // base->quote to quote->base
    }
  });
  return out;
}
async function updateFxFromNetwork(quotes){
  const base=state.prefs.baseCurrency;
  try{
    const rates=await fetchRatesOpenERAPI(base, quotes);
    const updated=[];
    for(const [q,r] of Object.entries(rates)){
      const key=pkey(`fx:${q}`);
      await idb.put('fxrates',{key,profileId:state.profileId,quote:q,rate:r,updatedAt:new Date().toISOString()});
      state.fxrates[q]=r; updated.push(q);
    }
    renderAll();
    alert(updated.length? ('æ±‡ç‡å·²æ›´æ–°ï¼ˆå¤–å¸â†’åŸºå‡†ï¼‰ï¼š'+updated.join(', ')) : 'æœªè·å–åˆ°ä»»ä½•æ±‡ç‡');
  }catch(e){
    alert('è”ç½‘è·å–å¤±è´¥ï¼š'+e.message);
  }
}

// ====== åˆå§‹åŒ– ======
const TABS=[
  {id:'dashboard',label:'ä»ªè¡¨ç›˜'},
  {id:'accounts',label:'è´¦æˆ·'},
  {id:'trans',label:'äº¤æ˜“'},
  {id:'budget',label:'é¢„ç®—'},
  {id:'reports',label:'æŠ¥è¡¨'},
  {id:'settings',label:'è®¾ç½®'}
];
function renderTabs(){
  const nav=$('#tabs'); nav.innerHTML='';
  TABS.forEach((t,i)=>{
    const btn=document.createElement('button');
    btn.className=''+(i===0?'active':'');
    btn.textContent=t.label; btn.dataset.target='#sec-'+t.id;
    btn.onclick=()=>{ $$('.section').forEach(s=>s.classList.remove('active')); $(btn.dataset.target).classList.add('active'); $$('#tabs button').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); if(t.id==='reports'){ renderReports(); } if(t.id==='dashboard'){ renderAcctDonut(); } };
    nav.appendChild(btn);
  });
}
async function boot(){
  await openDB();
  renderTabs();
  bindEvents();
  await loadProfile(state.profileId, true);
  renderAll();
}
async function loadProfile(profileId, initSample=false){
  state.profileId = profileId || 'default';
  setCurrentProfile(state.profileId);
  $('#profileIdShow').textContent = state.profileId;

  const prefsBase=await idb.getPrefRaw(pkey('baseCurrency'));
  const prefsMask=await idb.getPrefRaw(pkey('maskAmounts'));
  const prefsTheme=await idb.getPrefRaw(pkey('theme'));
  state.prefs.baseCurrency=prefsBase||'CNY';
  state.prefs.maskAmounts=!!prefsMask;
  state.prefs.theme=prefsTheme||'dark';
  mask=state.prefs.maskAmounts;
  applyTheme(state.prefs.theme);
  $('#baseCurrency').value=state.prefs.baseCurrency;
  $('#maskAmounts').value=String(state.prefs.maskAmounts);
  $('#themeSelect').value=state.prefs.theme;

  const allAcc=await idb.getAll('accounts');
  const allTx =await idb.getAll('transactions');
  const allBdg=await idb.getAll('budgets');
  const allFx =await idb.getAll('fxrates');

  state.accounts = allAcc.filter(a=>(a.profileId||'default')===state.profileId);
  state.txs      = allTx .filter(t=>(t.profileId||'default')===state.profileId);
  state.budgets  = {}; allBdg.filter(b=>b.profileId===state.profileId).forEach(b=>state.budgets[b.category]=Number(b.amount)||0);
  state.fxrates  = {}; allFx .filter(r=>r.profileId===state.profileId).forEach(r=>state.fxrates[r.quote]=Number(r.rate)||0);

  if(initSample && state.accounts.length===0 && state.profileId==='default'){
    const a1={id:uid(),profileId:state.profileId,name:'ç°é‡‘',type:'cash',currency:state.prefs.baseCurrency,includeInNetWorth:true,openingBalance:200,createdAt:new Date().toISOString(),sort:0};
    const a2={id:uid(),profileId:state.profileId,name:'é“¶è¡Œå¡',type:'bank',currency:state.prefs.baseCurrency,includeInNetWorth:true,openingBalance:1200,createdAt:new Date().toISOString(),sort:1};
    const a3={id:uid(),profileId:state.profileId,name:'USD æ´»æœŸ',type:'bank',currency:'USD',includeInNetWorth:true,openingBalance:100,createdAt:new Date().toISOString(),sort:2};
    await idb.put('accounts',a1);await idb.put('accounts',a2);await idb.put('accounts',a3);
    state.accounts=[a1,a2,a3];
    const t1={id:uid(),profileId:state.profileId,date:todayStr(),accountId:a2.id,side:'out',amount:35.8,category:'é¤é¥®',payee:'å’–å•¡',memo:'æ‹¿é“',createdAt:new Date().toISOString()};
    await idb.put('transactions',t1); state.txs=[t1];
    if(state.prefs.baseCurrency==='CNY'){
      const key=pkey('fx:USD'); const sampleFx={key,profileId:state.profileId,quote:'USD',rate:7.10,updatedAt:new Date().toISOString()};
      await idb.put('fxrates',sampleFx); state.fxrates['USD']=7.10;
    }
  }
  const CATS=['é¤é¥®','äº¤é€š','å±…ä½','æ•°ç ','å¨±ä¹','æ•™è‚²','åŒ»ç–—','æ—¥ç”¨','æ—…è¡Œ','è½¬è´¦-å…¥','è½¬è´¦-å‡º','å…¶ä»–'];
  $('#tx_category').innerHTML=CATS.filter(c=>!c.startsWith('è½¬è´¦')).map(c=>`<option value="${c}">${c}</option>`).join('');
  $('#bdg_category').innerHTML=CATS.filter(c=>!c.startsWith('è½¬è´¦')).map(c=>`<option value="${c}">${c}</option>`).join('');
}

// ====== äº‹ä»¶ç»‘å®š ======
function bindEvents(){
  $$('[data-nav]').forEach(b=>b.onclick=()=>{ $$('.section').forEach(s=>s.classList.remove('active')); $(b.dataset.nav).classList.add('active'); $$('#tabs button').forEach(btn=>btn.classList.toggle('active', btn.dataset.target===b.dataset.nav)); if(b.dataset.nav==='#sec-reports'){ renderReports(); } if(b.dataset.nav==='#sec-dashboard'){ renderAcctDonut(); }});

  $('#switchIdBtn').onclick=async ()=>{
    const id=prompt('è¾“å…¥è¦åˆ‡æ¢/æ–°å»ºçš„ IDï¼š', state.profileId);
    if(id==null) return;
    const rid=(id.trim()||'default').slice(0,40);
    await loadProfile(rid);
    renderAll();
  };

  $('#toggleMaskBtn').onclick=()=>{mask=!mask; renderAll(); $('#maskAmounts').value=String(mask); savePrefs();};
  $('#toggleThemeBtn').onclick=()=>{ const next= state.prefs.theme==='dark' ? 'light':'dark'; applyTheme(next); $('#themeSelect').value=next; savePrefs(); };

  $('#btnAddAccount').onclick=()=>{$('#accountForm').scrollIntoView({behavior:'smooth'});$('#acc_name').focus();};
  $('#btnResetAccountForm').onclick=()=>resetAccountForm();
  $('#accountForm').onsubmit=onSaveAccount;

  $('#tx_type').onchange=()=>toggleTransferFields();
  $('#txnForm').onsubmit=saveTransaction;
  $('#btnResetTx').onclick=()=>endEditTx();
  $('#btnCancelEditTx').onclick=()=>endEditTx();
  document.addEventListener('keydown',e=>{if(e.key.toLowerCase()==='n'){ $('#tx_amount').focus(); $('#sec-trans').classList.add('active'); $$('#tabs button').forEach(btn=>btn.classList.toggle('active', btn.dataset.target==='#sec-trans')); }});

  $('#btnClearFilter').onclick=()=>{ $('#filter_account').value=''; $('#filter_kw').value=''; renderTxTable(); };
  $('#filter_account').onchange=renderTxTable; $('#filter_kw').oninput=renderTxTable;

  $('#budgetForm').onsubmit=onSaveBudget;
  $('#btnResetBudget').onclick=()=>endEditBudget();
  $('#btnCancelEditBudget').onclick=()=>endEditBudget();

  $('#prefsForm').onsubmit=onSavePrefs;

  $('#fxForm').onsubmit=saveFxRate; $('#fxReset').onclick=()=>{$('#fx_quote').value=''; $('#fx_rate').value='';};
  $('#fxFetchAccounts').onclick=async ()=>{
    const base=state.prefs.baseCurrency;
    const quotes=[...new Set(state.accounts.map(a=>a.currency).filter(c=>c!==base))];
    if(quotes.length===0){ alert('æ²¡æœ‰éœ€è¦æ›´æ–°çš„å¤–å¸è´¦æˆ·'); return; }
    await updateFxFromNetwork(quotes);
  };
  $('#fxFetchAll').onclick=async ()=>{
    const base=state.prefs.baseCurrency;
    const COMMON=['USD','EUR','HKD','JPY','GBP','AUD','CAD','SGD','TWD','KRW'];
    const quotes=COMMON.filter(c=>c!==base);
    await updateFxFromNetwork(quotes);
  };

  window.addEventListener('resize',()=>{ if($('#sec-reports').classList.contains('active')) renderReports(); if($('#sec-dashboard').classList.contains('active')) renderAcctDonut(); });
}

function resetAccountForm(){ $('#accountForm').reset(); $('#acc_id').value=''; $('#acc_currency').value=state.prefs.baseCurrency; }
async function onSaveAccount(e){e.preventDefault();
  const id=$('#acc_id').value||uid();
  const acc={
    id, profileId:state.profileId,
    name:$('#acc_name').value.trim()||'æœªå‘½å',
    type:$('#acc_type').value,
    currency:$('#acc_currency').value,
    includeInNetWorth:$('#acc_in_net').value==='true',
    openingBalance:parseFloat($('#acc_opening').value)||0,
    sort:parseInt($('#acc_sort').value||0),
    createdAt:new Date().toISOString()
  };
  await idb.put('accounts',acc);
  const idx=state.accounts.findIndex(a=>a.id===id);
  if(idx>=0) state.accounts[idx]=acc; else state.accounts.push(acc);
  resetAccountForm(); renderAll(); alert('è´¦æˆ·å·²ä¿å­˜ï¼ˆIDï¼š'+state.profileId+'ï¼‰');
}

// ====== äº¤æ˜“ï¼šç¼–è¾‘/ä¿å­˜ ======
function toggleTransferFields(){
  const isT=$('#tx_type').value==='transfer' || $('#tx_edit_transfer').value==='1';
  $$('.transfer-only').forEach(x=>x.style.display=isT?'block':'none');
  $$('.non-transfer').forEach(x=>x.style.display=isT?'none':'block');
  if($('#tx_edit_transfer').value==='1'){
    // ç¼–è¾‘è½¬è´¦æ—¶ï¼Œé”å®šç±»å‹é€‰æ‹©
    $('#tx_type').disabled=true;
  }else{
    $('#tx_type').disabled=false;
  }
}
function startEditTx(t){
  $('#sec-trans').classList.add('active');
  $$('#tabs button').forEach(btn=>btn.classList.toggle('active', btn.dataset.target==='#sec-trans'));
  document.getElementById('txnForm').classList.add('editing');
  $('#txEditingPill').parentElement.classList.add('editing');
  $('#txEditingPill').style.display='inline-flex';
  $('#btnCancelEditTx').style.display='inline-block';

  $('#tx_edit_id').value=t.id;
  $('#tx_edit_peer_id').value=t.transferPeerId||'';
  $('#tx_edit_transfer').value=t.isTransfer?'1':'';

  $('#tx_date').value=t.date;
  $('#tx_amount').value=String(t.amount);
  $('#tx_payee').value=t.payee||'';
  $('#tx_memo').value=t.memo||'';

  if(t.isTransfer){
    $('#tx_type').value='transfer';
    $('#tx_account').value=t.side==='out'? t.accountId : (t.transferPeerId? state.txs.find(x=>x.id===t.transferPeerId)?.accountId : '');
    const peer = t.side==='out'? (t.transferPeerId? state.txs.find(x=>x.id===t.transferPeerId) : null) : t;
    $('#tx_target').value=peer? peer.accountId : '';
  }else{
    $('#tx_type').value=t.side==='in' ? 'in' : 'out';
    $('#tx_account').value=t.accountId;
    $('#tx_category').value=t.category||$('#tx_category').value;
  }
  toggleTransferFields();
}
function endEditTx(){
  $('#tx_edit_id').value=''; $('#tx_edit_peer_id').value=''; $('#tx_edit_transfer').value='';
  $('#txnForm').reset(); $('#tx_date').value=todayStr();
  $('#tx_type').disabled=false;
  document.getElementById('txnForm').classList.remove('editing');
  $('#txEditingPill').parentElement.classList.remove('editing');
  $('#txEditingPill').style.display='none';
  $('#btnCancelEditTx').style.display='none';
  toggleTransferFields();
}
async function saveTransaction(e){
  e.preventDefault();
  const isEditing = !!$('#tx_edit_id').value;
  const editingIsTransfer = $('#tx_edit_transfer').value==='1';
  const type=$('#tx_type').value;
  const accId=$('#tx_account').value; if(!accId){alert('è¯·é€‰æ‹©è´¦æˆ·'); return;}
  const date=$('#tx_date').value||todayStr();
  const amt=parseFloat($('#tx_amount').value); if(!(amt>0)){alert('è¯·è¾“å…¥é‡‘é¢'); return;}
  const payee=$('#tx_payee').value.trim(); const memo=$('#tx_memo').value.trim();

  if(isEditing){
    if(editingIsTransfer){
      // ç¼–è¾‘å·²å­˜åœ¨çš„è½¬è´¦ï¼šæ›´æ–°ä¸¤æ¡è®°å½•
      const id1=$('#tx_edit_id').value;
      const id2=$('#tx_edit_peer_id').value;
      const t1=state.txs.find(x=>x.id===id1);
      const t2=state.txs.find(x=>x.id===id2);
      if(!t1 || !t2){ alert('æ‰¾ä¸åˆ°éœ€è¦ç¼–è¾‘çš„è½¬è´¦è®°å½•'); return; }
      const out = t1.side==='out'? t1 : t2;
      const inn = t1.side==='in' ? t1 : t2;
      out.date=date; out.accountId=accId; out.amount=amt; out.payee=payee; out.memo=memo;
      inn.date=date; inn.accountId=$('#tx_target').value; inn.amount=amt; inn.payee=payee; inn.memo=memo;
      await idb.put('transactions',out); await idb.put('transactions',inn);
      // æ›´æ–° state
      const i1=state.txs.findIndex(x=>x.id===out.id); if(i1>=0) state.txs[i1]=out;
      const i2=state.txs.findIndex(x=>x.id===inn.id); if(i2>=0) state.txs[i2]=inn;
      endEditTx(); renderAll(); alert('è½¬è´¦å·²æ›´æ–°');
      return;
    }else{
      // ç¼–è¾‘æ™®é€šæ”¶æ”¯ï¼ˆå…è®¸ in/out åˆ‡æ¢ï¼Œä¸å…è®¸æ”¹ä¸º transferï¼‰
      const id=$('#tx_edit_id').value;
      const t=state.txs.find(x=>x.id===id);
      if(!t){ alert('æ‰¾ä¸åˆ°éœ€è¦ç¼–è¾‘çš„è®°å½•'); return; }
      if(type==='transfer'){ alert('æ­£åœ¨ç¼–è¾‘çš„è®°å½•ä¸èƒ½æ”¹ä¸º"è½¬è´¦"ã€‚å¦‚éœ€è½¬è´¦ï¼Œè¯·æ–°å»ºä¸€æ¡ã€‚'); return; }
      t.date=date; t.accountId=accId; t.amount=amt; t.payee=payee; t.memo=memo; t.side=type; t.category=$('#tx_category').value;
      await idb.put('transactions',t);
      const idx=state.txs.findIndex(x=>x.id===id); if(idx>=0) state.txs[idx]=t;
      endEditTx(); renderAll(); alert('æµæ°´å·²æ›´æ–°');
      return;
    }
  }

  // æ–°å¢
  if(type==='transfer'){
    const target=$('#tx_target').value; if(!target||target===accId){alert('è¯·é€‰æ‹©ä¸åŒçš„ç›®æ ‡è´¦æˆ·'); return;}
    const id1=uid(), id2=uid();
    const tOut={id:id1,profileId:state.profileId,date,accountId:accId,side:'out',amount:amt,category:'è½¬è´¦-å‡º',payee,memo,isTransfer:true,transferPeerId:id2,createdAt:new Date().toISOString()};
    const tIn ={id:id2,profileId:state.profileId,date,accountId:target,side:'in', amount:amt,category:'è½¬è´¦-å…¥',payee,memo,isTransfer:true,transferPeerId:id1,createdAt:new Date().toISOString()};
    await idb.put('transactions',tOut); await idb.put('transactions',tIn);
    state.txs.push(tOut,tIn);
  } else {
    const t={id:uid(),profileId:state.profileId,date,accountId:accId,side:type,amount:amt,category:$('#tx_category').value,payee,memo,isTransfer:false,createdAt:new Date().toISOString()};
    await idb.put('transactions',t); state.txs.push(t);
  }
  $('#txnForm').reset(); $('#tx_date').value=todayStr(); renderAll(); alert('å·²ä¿å­˜');
}

// ====== é¢„ç®—ï¼šç¼–è¾‘/ä¿å­˜/åˆ é™¤ ======
async function onSaveBudget(e){ e.preventDefault();
  const cat=$('#bdg_category').value; const amt=parseFloat($('#bdg_amount').value)||0;
  const key=pkey('bdg:'+cat);
  const rec={key, profileId:state.profileId, category:cat, amount:amt};
  await idb.put('budgets',rec);
  state.budgets[cat]=amt;
  endEditBudget();
  renderBudget();
  alert('é¢„ç®—å·²ä¿å­˜');
}
function startEditBudget(cat){
  $('#bdg_edit_key').value=pkey('bdg:'+cat);
  $('#bdg_category').value=cat;
  $('#bdg_amount').value=state.budgets[cat]||0;
  $('#bdgEditingPill').parentElement.classList.add('editing');
  $('#bdgEditingPill').style.display='inline-flex';
  $('#btnCancelEditBudget').style.display='inline-block';
  $('#sec-budget').classList.add('active');
  $$('#tabs button').forEach(btn=>btn.classList.toggle('active', btn.dataset.target==='#sec-budget'));
  $('#bdg_amount').focus();
}
function endEditBudget(){
  $('#bdg_edit_key').value='';
  document.getElementById('budgetForm').reset();
  $('#bdgEditingPill').parentElement.classList.remove('editing');
  $('#bdgEditingPill').style.display='none';
  $('#btnCancelEditBudget').style.display='none';
}
async function deleteBudget(cat){
  const key=pkey('bdg:'+cat);
  if(!confirm('åˆ é™¤è¯¥ç±»åˆ«é¢„ç®—ï¼Ÿ')) return;
  await idb.del('budgets',key);
  delete state.budgets[cat];
  renderBudget();
}

// ====== æ¸²æŸ“ ======
function renderAll(){ fillAccountSelects(); renderDashboard(); renderAccountsTable(); renderTxTable(); renderBudget(); renderFxTable(); }

function fillAccountSelects(){
  const opts=state.accounts.sort((a,b)=>a.sort-b.sort).map(a=>`<option value="${a.id}">${a.name}</option>`).join('');
  $('#tx_account').innerHTML=opts; $('#tx_target').innerHTML=opts; $('#filter_account').innerHTML='<option value="">å…¨éƒ¨è´¦æˆ·</option>'+opts;
  $('#tx_date').value=todayStr();
}

function accountBalance(acc){
  let bal=Number(acc.openingBalance)||0;
  state.txs.filter(t=>t.accountId===acc.id).forEach(t=>{
    if(t.side==='in') bal+=Number(t.amount)||0; else if(t.side==='out') bal-=Number(t.amount)||0;
  });
  return bal;
}

function renderDashboard(){
  const base=state.prefs.baseCurrency;
  let income=0, expense=0, net=0; const missing=new Set();
  state.accounts.filter(a=>a.includeInNetWorth).forEach(a=>{
    const bal=accountBalance(a);
    const baseVal=amountToBase(bal,a.currency);
    if(baseVal===null) missing.add(a.currency); else net+=baseVal;
  });
  state.txs.filter(t=>sameMonth(t.date,new Date()) && !t.isTransfer).forEach(t=>{
    const acc=state.accounts.find(a=>a.id===t.accountId); if(!acc) return;
    const v=amountToBase(t.amount,acc.currency); if(v===null) return; if(t.side==='in') income+=v; if(t.side==='out') expense+=v;
  });
  $('#netWorth').textContent=fmtAmount(net,base);
  $('#monthIn').textContent=fmtAmount(income,base);
  $('#monthOut').textContent=fmtAmount(expense,base);
  $('#netWorthNote').textContent=missing.size? `ç¼ºå°‘ ${Array.from(missing).join(', ')} æ±‡ç‡ï¼Œç›¸å…³è´¦æˆ·æœªè®¡å…¥å‡€èµ„äº§ã€‚` : '';

  const wrap=$('#accountCards'); wrap.innerHTML='';
  state.accounts.sort((a,b)=>a.sort-b.sort).forEach(a=>{
    const bal=accountBalance(a);
    const baseVal=amountToBase(bal,a.currency);
    const card=document.createElement('div'); card.className='card';
    card.innerHTML=`<div class="content">
      <div class="row"><strong>${a.name}</strong><span class="space"></span><span class="tag">${a.type}</span></div>
      <div class="muted" style="margin:6px 0">å¸ç§ï¼š${a.currency} Â· ${a.includeInNetWorth? 'è®¡å…¥å‡€èµ„äº§':'ä¸è®¡å…¥'}</div>
      <div class="kpi"><span class="label">ä½™é¢</span><span class="value amount">${fmtAmount(bal,a.currency)}</span>
        ${baseVal!==null && a.currency!==base ? `<span class="note">â‰ˆ ${fmtAmount(baseVal,base)}</span>`:''}
      </div>
    </div>`;
    wrap.appendChild(card);
  });

  const tbody=$('#recentTxTable tbody'); tbody.innerHTML='';
  state.txs.sort((a,b)=>b.date.localeCompare(a.date)).slice(0,10).forEach(t=>{
    const acc=state.accounts.find(a=>a.id===t.accountId);
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${t.date}</td><td>${acc?acc.name:''}</td><td>${t.category||t.payee||''}${t.memo? ' Â· '+t.memo:''}</td>
    <td style='text-align:right' class='amount ${t.side==='in'?'positive':'negative'}'>${(t.side==='in'?'+':'-')+fmtAmount(t.amount,acc?acc.currency:state.prefs.baseCurrency)}</td>
    <td style='text-align:right'><button class='btn ghost' data-edit-tx='${t.id}'>ç¼–è¾‘</button></td>`;
    tbody.appendChild(tr);
  });
  $$('[data-edit-tx]').forEach(b=>b.onclick=()=>{
    const t=state.txs.find(x=>x.id===b.dataset.editTx); if(!t) return;
    startEditTx(t);
  });

  renderAcctDonut();
}

// ====== åœ†ç¯å›¾ ======
let donutCache=null;
function accountStructureData(){
  const base=state.prefs.baseCurrency;
  const labels=[]; const values=[]; const colors=[]; let idx=0;
  state.accounts.filter(a=>a.includeInNetWorth).forEach(a=>{
    const bal=accountBalance(a);
    const v=amountToBase(bal,a.currency);
    if(v!==null && Math.abs(v)>0.0001){
      labels.push(a.name);
      values.push(v);
      const hue=(idx*50)%360; colors.push(`hsl(${hue} 70% 55% / 1)`); idx++;
    }
  });
  return {labels,values,colors};
}
function setCanvasSize(cnv){
  const dpr=window.devicePixelRatio||1; const rect=cnv.getBoundingClientRect();
  cnv.width=Math.max(300, Math.floor(rect.width*dpr)); cnv.height=Math.floor(260*dpr);
  return dpr;
}
function drawDonutChart(cnv, labels, values, colors){
  const dpr=setCanvasSize(cnv); const ctx=cnv.getContext('2d');
  ctx.clearRect(0,0,cnv.width,cnv.height);
  const W=cnv.width, H=cnv.height; const R=Math.min(W,H)/2 - 30*dpr; const r=R*0.6; const cx=W/2, cy=H/2;
  const sum=values.reduce((a,b)=>a+b,0)||1; let start=-Math.PI/2;
  const arcs=[];
  values.forEach((v,i)=>{
    const ang=2*Math.PI*(v/sum); const end=start+ang; ctx.fillStyle=colors[i]||'#4c8bf5';
    ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,R,start,end); ctx.closePath(); ctx.fill();
    arcs.push({start,end,label:labels[i],value:v,color:colors[i],percent:(v/sum)});
    start=end;
  });
  ctx.globalCompositeOperation='destination-out';
  ctx.beginPath(); ctx.arc(cx,cy,r,0,2*Math.PI); ctx.fill();
  ctx.globalCompositeOperation='source-over';
  const text=getComputedStyle(document.body).getPropertyValue('--text')||'#e7edf3';
  const muted=getComputedStyle(document.body).getPropertyValue('--muted')||'#9fb3c8';
  ctx.fillStyle=text; ctx.font=`${14*dpr}px system-ui`; ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.fillText('èµ„äº§ç»“æ„', cx, cy-10*dpr);
  ctx.fillStyle=muted; ctx.font=`${12*dpr}px system-ui`; ctx.fillText('æŒ‰è´¦æˆ·ï¼ˆåŸºå‡†ï¼‰', cx, cy+10*dpr);
  donutCache={cx,cy,R,r,arcs,dpr};
}
function renderAcctDonut(){
  const {labels,values,colors}=accountStructureData();
  $('#acctDonutNote').textContent=`åŸºå‡†ï¼š${state.prefs.baseCurrency}`;
  const cnv=$('#acctDonut');
  drawDonutChart(cnv, labels, values, colors);
  const lg=$('#acctLegend'); lg.innerHTML='';
  const total=values.reduce((a,b)=>a+b,0)||1;
  labels.forEach((lb,i)=>{
    const item=document.createElement('div'); item.className='item';
    const sw=document.createElement('span'); sw.className='swatch'; sw.style.background=colors[i]; item.appendChild(sw);
    const pct=((values[i]/total)*100).toFixed(1)+'%';
    item.appendChild(document.createTextNode(`${lb} Â· ${pct}`));
    lg.appendChild(item);
  });
  if(!cnv._hoverBound){
    cnv.addEventListener('mousemove', onDonutHover);
    cnv.addEventListener('mouseleave', ()=>{ const t=$('#tooltip'); t.style.display='none'; });
    cnv._hoverBound=true;
  }
}
function onDonutHover(e){
  if(!donutCache){ return; }
  const rect=e.target.getBoundingClientRect();
  const scale=(window.devicePixelRatio||1);
  const x=(e.clientX - rect.left) * scale;
  const y=(e.clientY - rect.top)  * scale;
  const {cx,cy,R,r,arcs}=donutCache;
  const dx=x - cx, dy=y - cy; const dist=Math.sqrt(dx*dx+dy*dy);
  const t=$('#tooltip');
  if(dist<r || dist>R){ t.style.display='none'; return; }
  let ang=Math.atan2(dy,dx);
  if(ang< -Math.PI/2){ ang+=2*Math.PI; }
  const hit=arcs.find(a=> ang>=a.start && ang<a.end);
  if(!hit){ t.style.display='none'; return; }
  const base=state.prefs.baseCurrency;
  const html=`<div class="title">${hit.label}</div>
    <div class="row"><span>é‡‘é¢</span><strong>${fmtAmount(hit.value, base)}</strong></div>
    <div class="row"><span>å æ¯”</span><strong>${(hit.percent*100).toFixed(1)}%</strong></div>`;
  t.innerHTML=html;
  t.style.display='block';
  const pad=10; let tx=e.clientX+12, ty=e.clientY+12;
  const vw=window.innerWidth, vh=window.innerHeight;
  const tw=t.offsetWidth||160, th=t.offsetHeight||80;
  if(tx+tw+pad>vw) tx=vw-tw-pad;
  if(ty+th+pad>vh) ty=vh-th-pad;
  t.style.left=tx+'px'; t.style.top=ty+'px';
}

// ====== è´¦æˆ·è¡¨ï¼ˆæ‹–åŠ¨æ’åºï¼‰ ======
function renderAccountsTable(){
  const tb=$('#accountsTable tbody'); tb.innerHTML='';
  const base=state.prefs.baseCurrency;
  state.accounts.sort((a,b)=>a.sort-b.sort).forEach(a=>{
    const bal=accountBalance(a); const baseVal=amountToBase(bal,a.currency);
    const tr=document.createElement('tr'); tr.dataset.id=a.id; tr.draggable=true;
    tr.innerHTML=`<td class='drag-handle' title='æ‹–åŠ¨æ’åº'>â‹®â‹®</td><td>${a.name}</td><td>${a.type}</td><td>${a.currency}</td><td>${a.includeInNetWorth?'æ˜¯':'å¦'}</td>
      <td style='text-align:right' class='amount'>${fmtAmount(bal,a.currency)}</td>
      <td style='text-align:right' class='amount'>${baseVal!==null? fmtAmount(baseVal,base): '<span class="note">â€” ç¼ºæ±‡ç‡</span>'}</td>
      <td style='text-align:right'>
        <button class='btn ghost' data-edit='${a.id}'>ç¼–è¾‘</button>
        <button class='btn ghost' data-del='${a.id}'>åˆ é™¤</button>
      </td>`;
    tb.appendChild(tr);
  });
  $$('[data-edit]').forEach(b=>b.onclick=()=>{
    const a=state.accounts.find(x=>x.id===b.dataset.edit); if(!a) return;
    $('#acc_id').value=a.id; $('#acc_name').value=a.name; $('#acc_type').value=a.type; $('#acc_currency').value=a.currency;
    $('#acc_in_net').value=String(a.includeInNetWorth); $('#acc_opening').value=a.openingBalance; $('#acc_sort').value=a.sort;
    $('#sec-accounts').classList.add('active'); $$('#tabs button').forEach(btn=>btn.classList.toggle('active', btn.dataset.target==='#sec-accounts'));
    $('#accountForm').scrollIntoView({behavior:'smooth'});
  });
  $$('[data-del]').forEach(b=>b.onclick=async ()=>{
    const a=state.accounts.find(x=>x.id===b.dataset.del); if(!a) return;
    if(state.txs.some(t=>t.accountId===a.id)){ if(!confirm('è¯¥è´¦æˆ·å­˜åœ¨äº¤æ˜“è®°å½•ï¼Œåˆ é™¤å°†ä¿ç•™äº¤æ˜“ä½†å­¤ç«‹ã€‚ç¡®è®¤åˆ é™¤ï¼Ÿ')) return; }
    await idb.del('accounts',a.id); state.accounts=state.accounts.filter(x=>x.id!==a.id); renderAll();
  });
  let draggingId=null;
  tb.addEventListener('dragstart',e=>{
    const tr=e.target.closest('tr'); if(!tr) return;
    draggingId=tr.dataset.id; tr.classList.add('dragging'); e.dataTransfer.effectAllowed='move';
  });
  tb.addEventListener('dragend',e=>{
    const tr=e.target.closest('tr'); if(tr) tr.classList.remove('dragging'); draggingId=null;
    $$('#accountsTable tbody tr').forEach(r=>r.classList.remove('drop-target'));
  });
  tb.addEventListener('dragover',e=>{
    e.preventDefault();
    const tr=e.target.closest('tr'); if(!tr) return;
    $$('#accountsTable tbody tr').forEach(r=>r.classList.remove('drop-target'));
    tr.classList.add('drop-target');
  });
  tb.addEventListener('drop',async e=>{
    e.preventDefault();
    const targetTr=e.target.closest('tr'); if(!targetTr || !draggingId) return;
    const targetId=targetTr.dataset.id;
    if(targetId===draggingId) return;
    const order=state.accounts.sort((a,b)=>a.sort-b.sort).map(a=>a.id);
    const from=order.indexOf(draggingId), to=order.indexOf(targetId);
    if(from<0||to<0) return;
    order.splice(to,0, order.splice(from,1)[0]);
    state.accounts.forEach(a=>{ a.sort=(order.indexOf(a.id)+1)*10; idb.put('accounts',a); });
    renderAll();
  });
}

function renderTxTable(){
  const acct=$('#filter_account').value; const kw=$('#filter_kw').value.trim().toLowerCase();
  const tb=$('#txTable tbody'); tb.innerHTML='';
  let list=[...state.txs];
  if(acct) list=list.filter(t=>t.accountId===acct);
  if(kw) list=list.filter(t=> (t.category||'').toLowerCase().includes(kw) || (t.payee||'').toLowerCase().includes(kw) || (t.memo||'').toLowerCase().includes(kw));
  list.sort((a,b)=>b.date.localeCompare(a.date));
  list.forEach(t=>{
    const acc=state.accounts.find(a=>a.id===t.accountId);
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${t.date}</td><td>${acc?acc.name:''}</td><td>${t.isTransfer? 'è½¬è´¦':(t.side==='in'?'æ”¶å…¥':'æ”¯å‡º')}</td>
      <td>${t.category||''}${t.payee? ' Â· '+t.payee:''}</td><td>${t.memo||''}</td>
      <td style='text-align:right' class='amount ${t.side==='in'?'positive':'negative'}'>${(t.side==='in'?'+':'-')+fmtAmount(t.amount,acc?acc.currency:state.prefs.baseCurrency)}</td>
      <td style='text-align:right'>
        <button class='btn ghost' data-edit-tx='${t.id}'>ç¼–è¾‘</button>
        <button class='btn ghost' data-rm='${t.id}'>åˆ é™¤</button>
      </td>`;
    tb.appendChild(tr);
  });
  $$('[data-rm]').forEach(b=>b.onclick=async ()=>{
    const t=state.txs.find(x=>x.id===b.dataset.rm); if(!t) return;
    if(t.isTransfer && t.transferPeerId){ await idb.del('transactions',t.transferPeerId); state.txs=state.txs.filter(x=>x.id!==t.transferPeerId); }
    await idb.del('transactions',t.id); state.txs=state.txs.filter(x=>x.id!==t.id); renderAll();
  });
  $$('[data-edit-tx]').forEach(b=>b.onclick=()=>{
    const t=state.txs.find(x=>x.id===b.dataset.editTx); if(!t) return;
    startEditTx(t);
  });
}

function renderBudget(){
  $('#budgetMonthLabel').textContent=ym(new Date());
  const wrap=$('#budgetGrid'); wrap.innerHTML='';
  const spent={};
  state.txs.filter(t=>t.side==='out' && !t.isTransfer && sameMonth(t.date,new Date())).forEach(t=>{
    const acc=state.accounts.find(a=>a.id===t.accountId); if(!acc) return;
    const v=amountToBase(t.amount,acc.currency); if(v===null) return;
    const c=t.category||'å…¶ä»–'; spent[c]=(spent[c]||0)+v;
  });
  const categories=[...new Set([...Object.keys(state.budgets), ...Object.keys(spent)])];
  categories.forEach(c=>{
    const bAmt=Number(state.budgets[c]||0), sAmt=Number(spent[c]||0);
    const pct=bAmt>0? Math.min(100, Math.round(sAmt/bAmt*100)) : 0;
    const card=document.createElement('div'); card.className='card';
    card.innerHTML=`<div class='content'>
      <div class='row'><strong>${c}</strong><span class='space'></span><span class='muted'>é¢„ç®—ï¼š${fmtAmount(bAmt,state.prefs.baseCurrency)}</span></div>
      <div class='row' style='margin-top:6px'><div class='progress' style='flex:1'><i style='width:${pct}%'></i></div> <span class='pill'>${pct}%</span></div>
      <div class='row' style='margin-top:6px'><span class='muted'>å·²ç”¨ï¼š</span><strong class='amount negative'>-${fmtAmount(sAmt,state.prefs.baseCurrency)}</strong><span class='space'></span><span class='muted'>å‰©ä½™ï¼š</span><strong>${fmtAmount(Math.max(0,bAmt-sAmt),state.prefs.baseCurrency)}</strong></div>
      <div class='row' style='margin-top:8px;justify-content:flex-end;gap:8px'>
        <button class='btn ghost' data-bdg-edit='${c}'>ç¼–è¾‘</button>
        <button class='btn ghost' data-bdg-del='${c}'>åˆ é™¤</button>
      </div>
    </div>`;
    wrap.appendChild(card);
  });
  $$('[data-bdg-edit]').forEach(b=>b.onclick=()=>startEditBudget(b.dataset.bdgEdit));
  $$('[data-bdg-del]').forEach(b=>b.onclick=()=>deleteBudget(b.dataset.bdgDel));
}

function renderFxTable(){
  const tb=$('#fxTable tbody'); tb.innerHTML='';
  const nowStr=new Date().toLocaleString();
  Object.keys(state.fxrates).sort().forEach(q=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${q}</td><td style='text-align:right'>${Number(state.fxrates[q]).toFixed(4)}</td><td>${nowStr}</td>
      <td style='text-align:right'>
        <button class='btn ghost' data-fxedit='${q}'>ç¼–è¾‘</button>
        <button class='btn ghost' data-fxdel='${q}'>åˆ é™¤</button>
      </td>`;
    tb.appendChild(tr);
  });
  $$('[data-fxedit]').forEach(b=>b.onclick=()=>{ const q=b.dataset.fxedit; $('#fx_quote').value=q; $('#fx_rate').value=state.fxrates[q]; $('#fx_quote').focus(); });
  $$('[data-fxdel]').forEach(b=>b.onclick=async ()=>{ const q=b.dataset.fxdel; const key=pkey('fx:'+q); await idb.del('fxrates',key); delete state.fxrates[q]; renderAll(); });
}

async function onSavePrefs(e){ e.preventDefault(); const oldBase=state.prefs.baseCurrency;
  state.prefs.baseCurrency=$('#baseCurrency').value;
  state.prefs.maskAmounts=$('#maskAmounts').value==='true';
  state.prefs.theme=$('#themeSelect').value;
  mask=state.prefs.maskAmounts; applyTheme(state.prefs.theme);
  await savePrefs(); renderAll();
  if(oldBase!==state.prefs.baseCurrency){ alert('å·²æ›´æ”¹åŸºå‡†è´§å¸ï¼šè¯·åœ¨"æ±‡ç‡ç®¡ç†"è”ç½‘æ›´æ–°æˆ–æ‰‹åŠ¨å¡«å…¥å¤–å¸â†’åŸºå‡†æ±‡ç‡ã€‚'); }
}

async function saveFxRate(e){
  e.preventDefault();
  let q=($('#fx_quote').value||'').trim().toUpperCase(); const r=parseFloat($('#fx_rate').value);
  if(!q||!(r>0)){ alert('è¯·å¡«å†™å¤–å¸ä»£ç ä¸æ­£ç¡®æ±‡ç‡'); return; }
  if(q===state.prefs.baseCurrency){ alert('æ— éœ€ä¸ºåŸºå‡†è´§å¸è®¾ç½®æ±‡ç‡'); return; }
  const rec={key:pkey('fx:'+q), profileId:state.profileId, quote:q, rate:r, updatedAt:new Date().toISOString()};
  await idb.put('fxrates',rec); state.fxrates[q]=r; renderAll(); alert('æ±‡ç‡å·²ä¿å­˜');
}

// ====== æŠ¥è¡¨ ======
function lastNMonthsLabels(n=12){
  const labels=[]; const now=new Date(); now.setDate(1);
  for(let i=n-1;i>=0;i--){ const d=new Date(now.getFullYear(), now.getMonth()-i, 1); labels.push(ym(d)); }
  return labels;
}
function monthlyIEBase(n=12){
  const labels=lastNMonthsLabels(n); const inc=Array(n).fill(0), exp=Array(n).fill(0);
  state.txs.filter(t=>!t.isTransfer).forEach(t=>{
    const idx=labels.indexOf(ym(t.date)); if(idx<0) return; const acc=state.accounts.find(a=>a.id===t.accountId); if(!acc) return;
    const v=amountToBase(t.amount,acc.currency); if(v===null) return; if(t.side==='in') inc[idx]+=v; if(t.side==='out') exp[idx]+=v;
  });
  return {labels,inc,exp};
}
function setCanvasSizePlot(cnv){
  const dpr=window.devicePixelRatio||1; const rect=cnv.getBoundingClientRect();
  cnv.width=Math.max(300, Math.floor(rect.width*dpr)); cnv.height=Math.floor(260*dpr);
  return dpr;
}
function drawLineChart(cnv, labels, s1, s2){
  const dpr=setCanvasSizePlot(cnv); const ctx=cnv.getContext('2d');
  ctx.clearRect(0,0,cnv.width,cnv.height);
  const W=cnv.width, H=cnv.height, pad=40*dpr;
  const all=[...s1,...s2]; const max=Math.max(1, Math.ceil(Math.max(...all,0)*1.2));
  ctx.strokeStyle='#2b394a'; ctx.lineWidth=1*dpr; ctx.beginPath(); ctx.moveTo(pad, H-pad); ctx.lineTo(W-pad, H-pad); ctx.lineTo(W-pad, pad); ctx.stroke();
  const muted=getComputedStyle(document.body).getPropertyValue('--muted')||'#9fb3c8';
  const text=getComputedStyle(document.body).getPropertyValue('--text')||'#e7edf3';
  ctx.fillStyle=muted; ctx.font=`${11*dpr}px system-ui`;
  const ticks=4; for(let i=0;i<=ticks;i++){ const y=H-pad-(H-2*pad)/ticks*i; const val=max/ticks*i; ctx.fillText(val.toFixed(0), 6*dpr, y+4*dpr); ctx.strokeStyle='rgba(0,0,0,.1)'; ctx.beginPath(); ctx.moveTo(pad, y); ctx.lineTo(W-pad, y); ctx.stroke(); }
  const step=(W-2*pad)/(labels.length-1||1);
  labels.forEach((lb,i)=>{ const x=pad+i*step; ctx.save(); ctx.translate(x, H-pad+14*dpr); ctx.rotate(-Math.PI/5); ctx.fillText(lb, 0,0); ctx.restore(); });
  function plot(arr, color){ ctx.strokeStyle=color; ctx.lineWidth=2*dpr; ctx.beginPath(); arr.forEach((v,i)=>{ const x=pad+i*step; const y=H-pad - (v/max)*(H-2*pad); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); }); ctx.stroke(); }
  plot(s1,'#31c48d'); // income
  plot(s2,'#f05252'); // expense
  ctx.fillStyle=getComputedStyle(document.body).getPropertyValue('--panel')||'#12161c';
  ctx.strokeStyle=getComputedStyle(document.body).getPropertyValue('--border')||'#243140';
  ctx.fillRect(W-150*dpr, pad, 120*dpr, 30*dpr); ctx.strokeRect(W-150*dpr, pad, 120*dpr, 30*dpr);
  ctx.fillStyle=text; ctx.font=`${11*dpr}px system-ui`;
  ctx.fillText('æ”¶å…¥', W-140*dpr, pad+10*dpr); ctx.fillText('æ”¯å‡º', W-80*dpr, pad+10*dpr);
  ctx.fillStyle='#31c48d'; ctx.fillRect(W-148*dpr, pad+14*dpr, 10*dpr, 3*dpr);
  ctx.fillStyle='#f05252'; ctx.fillRect(W-88*dpr, pad+14*dpr, 10*dpr, 3*dpr);
}
function currentMonthExpenseByCat(){
  const map={}; const now=new Date();
  state.txs.filter(t=>t.side==='out' && !t.isTransfer && sameMonth(t.date,now)).forEach(t=>{
    const acc=state.accounts.find(a=>a.id===t.accountId); if(!acc) return; const v=amountToBase(t.amount,acc.currency); if(v===null) return;
    const c=t.category||'å…¶ä»–'; map[c]=(map[c]||0)+v;
  });
  const labels=Object.keys(map); const values=labels.map(k=>map[k]);
  return {labels,values};
}
function drawPieChart(cnv, labels, values){
  const dpr=setCanvasSizePlot(cnv); const ctx=cnv.getContext('2d');
  ctx.clearRect(0,0,cnv.width,cnv.height);
  const W=cnv.width, H=cnv.height; const R=Math.min(W,H)/2 - 30*dpr; const cx=W/2, cy=H/2;
  const sum=values.reduce((a,b)=>a+b,0)||1; let start=-Math.PI/2;
  values.forEach((v,i)=>{ const ang=2*Math.PI*(v/sum); const hue=(i*55)%360; ctx.fillStyle=`hsl(${hue} 70% 55% / 1)`; ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,R,start,start+ang); ctx.closePath(); ctx.fill(); start+=ang; });
  const muted=getComputedStyle(document.body).getPropertyValue('--muted')||'#9fb3c8';
  const text=getComputedStyle(document.body).getPropertyValue('--text')||'#e7edf3';
  ctx.fillStyle=text; ctx.font=`${12*dpr}px system-ui`;
  let ly=20*dpr; labels.forEach((lb,i)=>{ const hue=(i*55)%360; ctx.fillStyle=`hsl(${hue} 70% 60% / 1)`; ctx.fillRect(20*dpr, ly-8*dpr, 10*dpr, 10*dpr); ctx.fillStyle=muted; const val=values[i]; const pct=((val/sum)*100).toFixed(1)+'%'; ctx.fillText(`${lb} Â· ${pct}`, 36*dpr, ly); ly+=16*dpr; });
}
function renderReports(){
  const {labels,inc,exp}=monthlyIEBase(12);
  $('#trendNote').textContent=`åŸºå‡†ï¼š${state.prefs.baseCurrency}`;
  drawLineChart($('#lineChart'), labels, inc, exp);
  const pie=currentMonthExpenseByCat(); $('#pieNote').textContent=`æœˆä»½ï¼š${ym(new Date())} Â· åŸºå‡†ï¼š${state.prefs.baseCurrency}`;
  drawPieChart($('#pieChart'), pie.labels, pie.values);
}

// ====== å¯¼å…¥/å¯¼å‡ºï¼ˆä»…å½“å‰ IDï¼‰ ======
async function exportCurrentIdData(){
  const profile = state.profileId;
  const accounts = (await idb.getAll('accounts')).filter(x => (x.profileId||'default') === profile);
  const transactions = (await idb.getAll('transactions')).filter(x => (x.profileId||'default') === profile);
  const budgets = (await idb.getAll('budgets')).filter(x => x.profileId === profile);
  const fxrates = (await idb.getAll('fxrates')).filter(x => x.profileId === profile);
  const prefs = {
    baseCurrency: await idb.getPrefRaw(pkey('baseCurrency')),
    maskAmounts: await idb.getPrefRaw(pkey('maskAmounts')),
    theme: await idb.getPrefRaw(pkey('theme'))
  };
  const dump = {meta:{app:'ledger-adv', version:'v6.1', profileId:profile, exportedAt:new Date().toISOString()}, accounts, transactions, budgets, fxrates, prefs};
  const blob = new Blob([JSON.stringify(dump,null,2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `ledger-export-${profile}-${new Date().toISOString().slice(0,10)}.json`;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();}, 0);
}

async function importCurrentIdDataFromFile(file){
  try{
    const text = await file.text();
    let data;
    try{
      data = JSON.parse(text);
    }catch(parseErr){
      alert('å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶ä¸æ˜¯æœ‰æ•ˆçš„ JSONã€‚');
      return;
    }

    // å…ƒä¿¡æ¯ä¸é¢„è§ˆ
    const prof = state.profileId;
    const metaOk = !data.meta || data.meta.app === 'ledger-adv';
    const ac = Array.isArray(data.accounts) ? data.accounts.length : 0;
    const tx = Array.isArray(data.transactions) ? data.transactions.length : 0;
    const bd = Array.isArray(data.budgets) ? data.budgets.length : 0;
    const fx = Array.isArray(data.fxrates) ? data.fxrates.length : 0;
    const msg = [
      'å°†å¯¼å…¥æ•°æ®åˆ°å½“å‰ IDï¼š' + prof,
      `è´¦æˆ·ï¼š${ac} æ¡`,
      `äº¤æ˜“ï¼š${tx} æ¡`,
      `é¢„ç®—ï¼š${bd} æ¡`,
      `æ±‡ç‡ï¼š${fx} æ¡`,
      metaOk ? '' : 'âš ï¸ è­¦å‘Šï¼šæ–‡ä»¶æ¥æºä¸æ˜¯æœ¬åº”ç”¨å¯¼å‡ºï¼ˆmeta.appâ‰ ledger-advï¼‰ï¼Œå¯èƒ½ä¸å…¼å®¹ã€‚'
    ].filter(Boolean).join('\n');

    if(!confirm(msg + '\n\nç»§ç»­å¯¼å…¥å—ï¼Ÿï¼ˆå­˜åœ¨ç›¸åŒä¸»é”®çš„è®°å½•å°†è¢«è¦†ç›–ï¼›å¦‚éœ€å®Œå…¨æ›¿æ¢ï¼Œè¯·å…ˆå¯¼å‡ºå¤‡ä»½åå†"æ¸…ç©ºå½“å‰ ID æ•°æ®"å†å¯¼å…¥ï¼‰')) return;

    // ç°æœ‰ ID é›†
    const existingAccIds = new Set((state.accounts||[]).map(a=>a.id));
    const existingTxIds  = new Set((state.txs||[]).map(t=>t.id));

    // è´¦æˆ·å¯¼å…¥ï¼ˆå¤„ç† id å†²çªï¼‰
    const accountIdMap = {};
    if(Array.isArray(data.accounts)){
      for(const a of data.accounts){
        if(!a || !a.id) continue;
        a.profileId = prof;
        if(existingAccIds.has(a.id)){
          const oldId = a.id;
          a.id = (typeof uid==='function') ? uid() : (oldId + '-imp-' + Math.random().toString(36).slice(2,8));
          accountIdMap[oldId] = a.id;
        }
        await idb.put('accounts', a);
      }
    }

    // äº¤æ˜“å¯¼å…¥ï¼ˆä¸¤é˜¶æ®µï¼Œå¤„ç† accountId & transferPeerId & id å†²çªï¼‰
    if(Array.isArray(data.transactions)){
      const txIdMap = {};
      // ç¬¬ä¸€é˜¶æ®µï¼šé¢„åˆ†é…æ–° idï¼Œæ˜ å°„ accountId
      const staged = [];
      for(const t0 of data.transactions){
        if(!t0 || !t0.id) continue;
        const t = {...t0};
        t.profileId = prof;
        if(accountIdMap[t.accountId]) t.accountId = accountIdMap[t.accountId];
        if(existingTxIds.has(t.id)){
          const oldId = t.id;
          t.id = (typeof uid==='function') ? uid() : (oldId + '-imp-' + Math.random().toString(36).slice(2,8));
          txIdMap[oldId] = t.id;
        }
        staged.push(t);
      }
      // ç¬¬äºŒé˜¶æ®µï¼šä¿®æ­£ transferPeerId å¹¶å†™å…¥
      for(const t of staged){
        if(t.transferPeerId && txIdMap[t.transferPeerId]) t.transferPeerId = txIdMap[t.transferPeerId];
        await idb.put('transactions', t);
      }
    }

    // é¢„ç®—ï¼ˆæŒ‰ç±»åˆ«è¦†ç›–ï¼‰
    if(Array.isArray(data.budgets)){
      for(const b of data.budgets){
        if(!b || !b.category) continue;
        const rec = {key:pkey('bdg:'+b.category), profileId:prof, category:b.category, amount:Number(b.amount)||0};
        await idb.put('budgets', rec);
      }
    }

    // æ±‡ç‡ï¼ˆæŒ‰å¸ç§è¦†ç›–ï¼‰
    if(Array.isArray(data.fxrates)){
      for(const r of data.fxrates){
        if(!r || !r.quote) continue;
        const rec = {key:pkey('fx:'+r.quote), profileId:prof, quote:r.quote, rate:Number(r.rate)||0, updatedAt:new Date().toISOString()};
        await idb.put('fxrates', rec);
      }
    }

    // åå¥½ï¼ˆå¯é€‰ï¼‰
    if(data.prefs && typeof data.prefs==='object'){
      if(data.prefs.baseCurrency) await idb.setPrefRaw(pkey('baseCurrency'), data.prefs.baseCurrency);
      if(typeof data.prefs.maskAmounts!=='undefined') await idb.setPrefRaw(pkey('maskAmounts'), !!data.prefs.maskAmounts);
      if(data.prefs.theme) await idb.setPrefRaw(pkey('theme'), data.prefs.theme);
      if(typeof applyTheme === 'function') try{ applyTheme(); }catch(_){}
    }

    await loadProfile(prof);
    renderAll();
    alert('å¯¼å…¥å®Œæˆï¼');
  }catch(err){
    alert('å¯¼å…¥å¤±è´¥ï¼š'+(err && err.message ? err.message : err));
  }
}

async function clearCurrentIdData(){
  if(!confirm(`ç¡®å®šè¦æ¸…ç©ºå½“å‰ IDï¼ˆ${state.profileId}ï¼‰çš„è´¦æˆ·/äº¤æ˜“/é¢„ç®—/æ±‡ç‡æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚å»ºè®®å…ˆå¯¼å‡ºå¤‡ä»½ã€‚`)) return;
  const prof = state.profileId;
  const delFromStore = async (store, keyField='id')=>{
    const all = await idb.getAll(store);
    const mine = all.filter(x => (x.profileId||'default') === prof);
    for(const rec of mine){ await idb.del(store, rec[keyField]); }
  };
  await delFromStore('accounts','id');
  await delFromStore('transactions','id');
  // budgets & fxrates ä½¿ç”¨ key = pkey(...)
  const allB = await idb.getAll('budgets'); for(const b of allB.filter(x=>x.profileId===prof)){ await idb.del('budgets', b.key); }
  const allF = await idb.getAll('fxrates'); for(const r of allF.filter(x=>x.profileId===prof)){ await idb.del('fxrates', r.key); }

  await loadProfile(prof);
  renderAll();
  alert('å·²æ¸…ç©ºå½“å‰ ID æ•°æ®ã€‚');
}

// ç»‘å®šæŒ‰é’®ï¼ˆé¡µé¢åŠ è½½åï¼‰
window.addEventListener('load', ()=>{
  const pid=document.querySelector('#dataProfileId'); if(pid) pid.textContent=state.profileId;
  const bx=document.querySelector('#btnExportData'); if(bx) bx.onclick=exportCurrentIdData;
  const bi=document.querySelector('#btnImportData'); if(bi) bi.onclick=()=>document.querySelector('#importFile')?.click();
  const fi=document.querySelector('#importFile'); if(fi) fi.onchange=(e)=>{ const f=e.target.files && e.target.files[0]; if(f) importCurrentIdDataFromFile(f); e.target.value=''; };
  const bc=document.querySelector('#btnClearCurrentData'); if(bc) bc.onclick=clearCurrentIdData;
});


// ====== åŠ¨æ€åˆ·æ–°"å½“å‰ ID"æ˜¾ç¤º ======
function updateDataProfileId(){
  const el = document.querySelector('#dataProfileId');
  if(el) el.textContent = state && state.profileId ? state.profileId : '';
}
// åŒ…è£… loadProfile / renderAllï¼Œç¡®ä¿æ¯æ¬¡åˆ‡æ¢ ID æˆ–é‡ç»˜åéƒ½åŒæ­¥æ˜¾ç¤º
(function(){
  try{
    const _lp = (typeof loadProfile === 'function') ? loadProfile : null;
    if(_lp){
      window.loadProfile = async function(){
        const r = await _lp.apply(this, arguments);
        updateDataProfileId();
        return r;
      }
    }
  }catch(e){}
  try{
    const _ra = (typeof renderAll === 'function') ? renderAll : null;
    if(_ra){
      window.renderAll = function(){
        const r = _ra.apply(this, arguments);
        updateDataProfileId();
        return r;
      }
    }
  }catch(e){}
})();

// å¯åŠ¨
boot();
</script>
</body>
</html>